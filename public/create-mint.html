<!DOCTYPE html>
<html>
<head>
    <title>Create Music NFT Mint</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>üéµ Create Music NFT Mint</h1>
    
    <form id="createMintForm">
        <h3>Mint Settings</h3>
        <div>
            <label>Creator Wallet Address:</label>
            <input type="text" name="creatorWallet" required placeholder="Creator's Solana wallet address">
            <small>The wallet that will receive payment when someone mints this NFT</small>
        </div>
        
        <div>
            <label>Mint Price (SOL):</label>
            <input type="number" name="mintPrice" step="0.001" min="0" required placeholder="0.1">
            <small>Price in SOL (minimum 0.001 SOL)</small>
        </div>

        <h3>Page Display (Public Before Mint)</h3>
        <div>
            <label>Page Title:</label>
            <input type="text" name="pageTitle" required>
        </div>
        
        <div>
            <label>Page Text:</label>
            <textarea name="pageText" rows="3" placeholder="Description shown before minting"></textarea>
        </div>
        
        <div>
            <label>Page Image:</label>
            <input type="file" name="pageImage" accept="image/*" required>
        </div>

        <h3>NFT Content (Revealed After Mint)</h3>
        <div>
            <label>NFT Title:</label>
            <input type="text" name="title" required>
        </div>
        
        <div>
            <label>NFT Description:</label>
            <textarea name="description" rows="3"></textarea>
        </div>
        
        <div>
            <label>NFT Image:</label>
            <input type="file" name="image" accept="image/*" required>
        </div>
        
        <div>
            <label>Music File:</label>
            <input type="file" name="music" accept="audio/*" required>
        </div>
        
        <div>
            <label>Open Time (optional):</label>
            <input type="datetime-local" name="openTime">
            <small>Leave empty for immediate minting</small>
        </div>
        
        <button type="submit">Create Mint</button>
    </form>
    
    <div id="result"></div>
    <div><a href="/"><button type="button">‚Üê Back to Home</button></a></div>

    <script>
        let uploadedPageImageUrl = null;
        let uploadedImageUrl = null;
        let uploadedMusicUrl = null;

        // Validate Solana public key format
        function isValidSolanaAddress(address) {
            if (!address || typeof address !== 'string') return false;
            if (address.length < 32 || address.length > 44) return false;
            return /^[1-9A-HJ-NP-Za-km-z]+$/.test(address);
        }

        async function uploadFile(file, type) {
            const formData = new FormData();
            formData.append(type, file);
            const response = await fetch(`/api/upload-${type}`, { method: 'POST', body: formData });
            return await response.json();
        }

        document.getElementById('createMintForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const result = document.getElementById('result');
            
            try {
                // Validate creator wallet
                const creatorWallet = formData.get('creatorWallet');
                if (!isValidSolanaAddress(creatorWallet)) {
                    throw new Error('Invalid Solana wallet address format');
                }

                // Validate mint price
                const mintPrice = parseFloat(formData.get('mintPrice'));
                if (mintPrice < 0.001) {
                    throw new Error('Minimum mint price is 0.001 SOL');
                }
                if (mintPrice > 1000) {
                    throw new Error('Maximum mint price is 1000 SOL');
                }

                const pageImageFile = formData.get('pageImage');
                if (pageImageFile?.size > 0) {
                    result.innerHTML = '<div class="progress">üì∏ Uploading page image...</div>';
                    const pageImageResult = await uploadFile(pageImageFile, 'image');
                    if (!pageImageResult.success) throw new Error('Page image upload failed: ' + pageImageResult.error);
                    uploadedPageImageUrl = pageImageResult.path;
                }

                const imageFile = formData.get('image');
                if (imageFile?.size > 0) {
                    result.innerHTML = '<div class="progress">üì∏ Uploading NFT image...</div>';
                    const imageResult = await uploadFile(imageFile, 'image');
                    if (!imageResult.success) throw new Error('NFT image upload failed: ' + imageResult.error);
                    uploadedImageUrl = imageResult.path;
                }

                const musicFile = formData.get('music');
                if (musicFile?.size > 0) {
                    result.innerHTML = '<div class="progress">üéµ Uploading music...</div>';
                    const musicResult = await uploadFile(musicFile, 'music');
                    if (!musicResult.success) throw new Error('Music upload failed: ' + musicResult.error);
                    uploadedMusicUrl = musicResult.path;
                }

                result.innerHTML = '<div class="progress">üíæ Creating mint entry...</div>';
                const mintData = {
                    creatorWallet,
                    mintPrice,
                    pageTitle: formData.get('pageTitle'),
                    pageText: formData.get('pageText'),
                    pageImageUrl: uploadedPageImageUrl,
                    title: formData.get('title'),
                    description: formData.get('description'),
                    imageUrl: uploadedImageUrl,
                    musicUrl: uploadedMusicUrl
                };

                const openTime = formData.get('openTime');
                if (openTime) mintData.openTime = new Date(openTime).toISOString();

                const response = await fetch('/create-mint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(mintData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `
                        <div class="mint-card" style="background: #d4edda;">
                            <h3>‚úÖ Mint Created Successfully!</h3>
                            <p><strong>Mint ID:</strong> ${data.mintId}</p>
                            <p><strong>Asset Public Key:</strong> ${data.assetPubkey}</p>
                            <p><strong>Creator:</strong> ${creatorWallet}</p>
                            <p><strong>Price:</strong> ${mintPrice} SOL</p>
                            <a href="/mint.html?id=${data.mintId}"><button>Go to Mint Page</button></a>
                            <a href="/"><button type="button">‚Üê Back to Home</button></a>
                        </div>
                    `;
                    e.target.reset();
                    uploadedPageImageUrl = null;
                    uploadedImageUrl = null;
                    uploadedMusicUrl = null;
                } else {
                    result.innerHTML = `<div style="color: red;">‚ùå Error: ${data.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div style="color: red;">‚ùå Error: ${error.message}</div>`;
            }
        });
    </script>
</body>
</html>
